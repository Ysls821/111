<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰§æœ¬ç”Ÿæˆå™¨ v2.0 - å…¨æ¨¡å—</title>
    <style>
        /* å¤ç”¨ä¹‹å‰çš„æ·±è‰²ä¸»é¢˜ CSS */
        :root { --bg-dark: #1e1e1e; --bg-panel: #252526; --border: #3e3e42; --accent: #007acc; --text: #cccccc; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* å·¦ä¾§å¯¼èˆªæ  (æ–°) */
        .nav-bar {
            width: 60px;
            background: #333333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            border-right: 1px solid var(--border);
        }
        .nav-btn {
            width: 40px;
            height: 40px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: none;
            background: #444;
            color: #aaa;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-btn.active { background: var(--accent); color: white; }
        .nav-btn:hover { background: #555; }

        /* äºŒçº§ä¾§è¾¹æ  */
        .sidebar { width: 220px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .scene-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .scene-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 13px; }
        .scene-item:hover { background: #2a2d2e; }
        .scene-item.active { background: #37373d; border-left: 3px solid var(--accent); }
        .sidebar-header { padding: 10px; border-bottom: 1px solid var(--border); display: flex; gap: 5px; }

        /* ä¸»ç¼–è¾‘åŒº */
        .main-editor { flex: 1; padding: 20px; overflow-y: auto; background: var(--bg-dark); }
        .preview-panel { width: 300px; background: var(--bg-panel); border-left: 1px solid var(--border); padding: 10px; display: flex; flex-direction: column; }

        /* é€šç”¨è¡¨å•æ§ä»¶ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 12px; color: #888; }
        input, textarea, select { width: 100%; padding: 8px; background: #3c3c3c; border: 1px solid #3c3c3c; color: white; border-radius: 4px; }
        input:focus, textarea:focus { outline: 1px solid var(--accent); }
        textarea { min-height: 100px; resize: vertical; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; color: white; }
        .btn-primary { background: var(--accent); }
        .btn-danger { background: #d9534f; }
        .btn-success { background: #4caf50; }
        pre { background: #1e1e1e; padding: 10px; border-radius: 4px; flex: 1; overflow: auto; font-size: 12px; color: #9cdcfe; }
        
        .section-title { font-size: 18px; margin-bottom: 20px; color: white; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .option-card { background: #2d2d30; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border); }
        .char-card { background: #2d2d30; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border); }
    </style>
</head>
<body>

    <!-- 1. æœ€å·¦ä¾§å¤§å¯¼èˆª (æ¿å—åˆ‡æ¢) -->
    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchSection('world')" title="ä¸–ç•Œè§‚">ğŸŒ</button>
        <button class="nav-btn" onclick="switchSection('main')" title="ä¸»çº¿å‰§æƒ…">ğŸ“–</button>
        <button class="nav-btn" onclick="switchSection('branch')" title="æ™®é€šæ”¯çº¿">ğŸŒ¿</button>
        <button class="nav-btn" onclick="switchSection('char_route')" title="è§’è‰²ä¸“å±çº¿">â¤ï¸</button>
        <button class="nav-btn" onclick="switchSection('chars')" title="è§’è‰²è®¾å®š">ğŸ‘¤</button>
    </div>

    <!-- 2. äºŒçº§åˆ—è¡¨æ  (ä»…åœ¨å‰§æƒ…æ¿å—æ˜¾ç¤º) -->
    <div class="sidebar" id="sidebarPanel">
        <div class="sidebar-header">
            <button class="btn btn-primary" onclick="addItem()" style="width:100%">+ æ–°å»ºæ¡ç›®</button>
        </div>
        <ul class="scene-list" id="itemList">
            <!-- JS ç”Ÿæˆ -->
        </ul>
    </div>

    <!-- 3. ä¸­é—´ç¼–è¾‘åŒº -->
    <div class="main-editor">
        <h2 id="sectionTitle" class="section-title">ä¸–ç•Œè§‚è®¾ç½®</h2>

        <!-- A. ä¸–ç•Œè§‚è¡¨å• -->
        <div id="formWorld" class="editor-form">
            <div class="form-group">
                <label>ä¸–ç•Œè§‚åç§°</label>
                <input type="text" id="worldName" oninput="saveWorld()">
            </div>
            <div class="form-group">
                <label>èƒŒæ™¯è®¾å®š (èƒŒæ™¯æ•…äº‹ã€è§„åˆ™ã€åŠ›é‡ä½“ç³»)</label>
                <textarea id="worldDesc" style="height: 300px;" oninput="saveWorld()"></textarea>
            </div>
        </div>

        <!-- B. è§’è‰²è®¾å®šè¡¨å• -->
        <div id="formChar" class="editor-form" style="display:none;">
            <div id="charEditorContainer">
                <div class="form-group">
                    <label>è§’è‰² ID</label>
                    <input type="text" id="charId" disabled>
                </div>
                <div class="form-group">
                    <label>å§“å</label>
                    <input type="text" id="charName" oninput="saveCurrentItem()">
                </div>
                <div class="form-group">
                    <label>äººè®¾ Prompt (æ€§æ ¼ã€å¤–è²Œã€è¯´è¯é£æ ¼)</label>
                    <textarea id="charPersona" style="height: 150px;" oninput="saveCurrentItem()"></textarea>
                </div>
                <div class="form-group">
                    <label>å¤´åƒ URL</label>
                    <input type="text" id="charAvatar" oninput="saveCurrentItem()">
                </div>
                <button class="btn btn-danger" onclick="deleteCurrentItem()">åˆ é™¤è§’è‰²</button>
            </div>
            <div id="charEmpty" style="display:none; color:#666;">è¯·åœ¨å·¦ä¾§é€‰æ‹©è§’è‰²</div>
        </div>

        <!-- C. å‰§æƒ…èŠ‚ç‚¹è¡¨å• (ä¸»çº¿/æ”¯çº¿å…±ç”¨) -->
        <div id="formScene" class="editor-form" style="display:none;">
            <div id="sceneEditorContainer">
                <div class="form-group">
                    <label>åœºæ™¯ ID</label>
                    <input type="text" id="sceneId" disabled>
                </div>
                <div class="form-group">
                    <label>ç±»å‹</label>
                    <select id="sceneType" onchange="saveCurrentItem()">
                        <option value="fixed">Fixed (å›ºå®šå‰§æœ¬)</option>
                        <option value="ai">AI (AIç”Ÿæˆ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å†…å®¹ / Prompt</label>
                    <textarea id="sceneContent" style="height: 150px;" oninput="saveCurrentItem()"></textarea>
                </div>
                <div class="form-group">
                    <label>èƒŒæ™¯å›¾ URL</label>
                    <input type="text" id="sceneBg" oninput="saveCurrentItem()">
                </div>
                <div class="form-group">
                    <label>é€‰é¡¹ (Options)</label>
                    <button class="btn btn-success btn-sm" onclick="addOption()">+ åŠ é€‰é¡¹</button>
                    <div id="optionsList" style="margin-top:10px;"></div>
                </div>
                <button class="btn btn-danger" onclick="deleteCurrentItem()">åˆ é™¤èŠ‚ç‚¹</button>
            </div>
            <div id="sceneEmpty" style="display:none; color:#666;">è¯·åœ¨å·¦ä¾§é€‰æ‹©å‰§æƒ…èŠ‚ç‚¹</div>
        </div>
    </div>

    <!-- 4. å³ä¾§é¢„è§ˆ -->
    <div class="preview-panel">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <label>æ•´åŒ…é¢„è§ˆ</label>
            <button class="btn btn-success btn-sm" onclick="exportJson()">ğŸ“¦ æ‰“åŒ…å¯¼å‡º</button>
        </div>
        <pre id="jsonPreview"></pre>
        <input type="file" id="importFile" style="display:none" onchange="importJson(this)">
        <button class="btn btn-primary" onclick="document.getElementById('importFile').click()" style="width:100%; margin-top:10px;">ğŸ“‚ å¯¼å…¥ç¼–è¾‘</button>
    </div>

    <script>
        // === å…¨å±€æ•°æ®ç»“æ„ ===
        let fullData = {
            worldview: { name: "", description: "" },
            characters: {},    // map: id -> {name, persona, avatar}
            main_story: {},    // map: id -> sceneObj
            side_stories: {},  // map: id -> sceneObj
            char_routes: {}    // map: id -> sceneObj
        };

        let currentSection = 'world'; // world, main, branch, char_route, chars
        let currentItemId = null;

        // === åˆå§‹åŒ– ===
        function init() {
            switchSection('world');
            renderPreview();
        }

        // === åˆ‡æ¢æ¿å— ===
        function switchSection(section) {
            currentSection = section;
            currentItemId = null;

            // 1. æ›´æ–°å·¦ä¾§å¯¼èˆªé«˜äº®
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.nav-btn')?.classList.add('active');

            // 2. æ›´æ–°æ ‡é¢˜
            const titles = {
                'world': 'ä¸–ç•Œè§‚è®¾å®š',
                'main': 'ä¸»çº¿å‰§æƒ… (Main Story)',
                'branch': 'æ™®é€šæ”¯çº¿ (Side Stories)',
                'char_route': 'è§’è‰²ä¸“å±çº¿ (Character Routes)',
                'chars': 'è§’è‰²è®¾å®š (Characters)'
            };
            document.getElementById('sectionTitle').textContent = titles[section];

            // 3. åˆ‡æ¢ç¼–è¾‘å™¨æ˜¾ç¤º
            document.querySelectorAll('.editor-form').forEach(el => el.style.display = 'none');
            
            // ä¾§è¾¹æ é€»è¾‘
            const sidebar = document.getElementById('sidebarPanel');
            
            if (section === 'world') {
                sidebar.style.display = 'none'; // ä¸–ç•Œè§‚ä¸éœ€è¦åˆ—è¡¨
                document.getElementById('formWorld').style.display = 'block';
                // å¡«å……æ•°æ®
                document.getElementById('worldName').value = fullData.worldview.name || "";
                document.getElementById('worldDesc').value = fullData.worldview.description || "";
            } else {
                sidebar.style.display = 'flex'; // å…¶ä»–éƒ½éœ€è¦åˆ—è¡¨
                renderSidebarList(); // æ¸²æŸ“å¯¹åº”æ¿å—çš„åˆ—è¡¨
                
                // æ˜¾ç¤ºå¯¹åº”çš„å³ä¾§ç©ºçŠ¶æ€
                if (section === 'chars') {
                    document.getElementById('formChar').style.display = 'block';
                    document.getElementById('charEditorContainer').style.display = 'none';
                    document.getElementById('charEmpty').style.display = 'block';
                } else {
                    document.getElementById('formScene').style.display = 'block';
                    document.getElementById('sceneEditorContainer').style.display = 'none';
                    document.getElementById('sceneEmpty').style.display = 'block';
                }
            }
        }

        // === æ¸²æŸ“ä¾§è¾¹æ åˆ—è¡¨ ===
        function renderSidebarList() {
            const listEl = document.getElementById('itemList');
            listEl.innerHTML = '';
            
            let dataMap = getDataMapBySection();
            
            Object.keys(dataMap).forEach(key => {
                const li = document.createElement('li');
                li.className = `scene-item ${key === currentItemId ? 'active' : ''}`;
                
                // æ˜¾ç¤ºåå­—ï¼ˆè§’è‰²æ˜¾ç¤ºnameï¼Œå‰§æƒ…æ˜¾ç¤ºIDï¼‰
                let label = key;
                if (currentSection === 'chars') label = dataMap[key].name || key;
                
                li.innerText = label;
                li.onclick = () => loadItem(key);
                listEl.appendChild(li);
            });
        }

        function getDataMapBySection() {
            if (currentSection === 'chars') return fullData.characters;
            if (currentSection === 'main') return fullData.main_story;
            if (currentSection === 'branch') return fullData.side_stories;
            if (currentSection === 'char_route') return fullData.char_routes;
            return {};
        }

        // === åŠ è½½æ¡ç›®è¯¦æƒ… ===
        function loadItem(id) {
            currentItemId = id;
            const dataMap = getDataMapBySection();
            const data = dataMap[id];
            renderSidebarList(); // æ›´æ–°é«˜äº®

            if (currentSection === 'chars') {
                document.getElementById('charEditorContainer').style.display = 'block';
                document.getElementById('charEmpty').style.display = 'none';
                
                document.getElementById('charId').value = id;
                document.getElementById('charName').value = data.name || "";
                document.getElementById('charPersona').value = data.persona || "";
                document.getElementById('charAvatar').value = data.avatar || "";
            } else {
                // å‰§æƒ…ç±»
                document.getElementById('sceneEditorContainer').style.display = 'block';
                document.getElementById('sceneEmpty').style.display = 'none';
                
                document.getElementById('sceneId').value = id;
                document.getElementById('sceneType').value = data.type || 'fixed';
                document.getElementById('sceneContent').value = data.text || data.prompt || "";
                document.getElementById('sceneBg').value = data.background || "";
                renderOptions(data.options || []);
            }
        }

        // === æ–°å»ºæ¡ç›® ===
        function addItem() {
            const ts = Date.now().toString().slice(-4);
            let newId = "";
            let newObj = {};

            if (currentSection === 'chars') {
                newId = "char_" + ts;
                newObj = { name: "æ–°è§’è‰²", persona: "", avatar: "" };
            } else {
                newId = currentSection + "_" + ts;
                newObj = { type: "fixed", text: "", options: [] };
            }

            getDataMapBySection()[newId] = newObj;
            loadItem(newId);
            renderSidebarList();
            renderPreview();
        }

        // === ä¿å­˜æ•°æ® ===
        function saveWorld() {
            fullData.worldview.name = document.getElementById('worldName').value;
            fullData.worldview.description = document.getElementById('worldDesc').value;
            renderPreview();
        }

        function saveCurrentItem() {
            if (!currentItemId) return;
            const map = getDataMapBySection();
            
            if (currentSection === 'chars') {
                map[currentItemId].name = document.getElementById('charName').value;
                map[currentItemId].persona = document.getElementById('charPersona').value;
                map[currentItemId].avatar = document.getElementById('charAvatar').value;
                // æ›´æ–°åˆ—è¡¨ä¸Šçš„åå­—
                renderSidebarList();
            } else {
                map[currentItemId].type = document.getElementById('sceneType').value;
                const content = document.getElementById('sceneContent').value;
                if (map[currentItemId].type === 'ai') {
                    map[currentItemId].prompt = content;
                    delete map[currentItemId].text;
                } else {
                    map[currentItemId].text = content;
                    delete map[currentItemId].prompt;
                }
                map[currentItemId].background = document.getElementById('sceneBg').value;
            }
            renderPreview();
        }

        function deleteCurrentItem() {
            if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
                delete getDataMapBySection()[currentItemId];
                currentItemId = null;
                // éšè—è¡¨å•
                if(currentSection === 'chars') document.getElementById('charEditorContainer').style.display = 'none';
                else document.getElementById('sceneEditorContainer').style.display = 'none';
                
                renderSidebarList();
                renderPreview();
            }
        }

        // === é€‰é¡¹é€»è¾‘ (å¤ç”¨) ===
        function renderOptions(opts) {
            const list = document.getElementById('optionsList');
            list.innerHTML = '';
            opts.forEach((opt, idx) => {
                const div = document.createElement('div');
                div.className = 'option-card';
                div.innerHTML = `
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <input placeholder="æŒ‰é’®æ–‡æ¡ˆ" value="${opt.label||''}" oninput="updateOpt(${idx}, 'label', this.value)">
                        <input placeholder="è·³è½¬ID" value="${opt.nextScene||''}" oninput="updateOpt(${idx}, 'nextScene', this.value)">
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="delOpt(${idx})">åˆ </button>
                `;
                list.appendChild(div);
            });
        }
        function addOption() {
            const map = getDataMapBySection();
            if(!map[currentItemId].options) map[currentItemId].options = [];
            map[currentItemId].options.push({label:"", nextScene:""});
            loadItem(currentItemId); // åˆ·æ–°
            renderPreview();
        }
        function updateOpt(idx, key, val) {
            getDataMapBySection()[currentItemId].options[idx][key] = val;
            renderPreview();
        }
        function delOpt(idx) {
            getDataMapBySection()[currentItemId].options.splice(idx, 1);
            loadItem(currentItemId);
            renderPreview();
        }

        // === å¯¼å…¥å¯¼å‡º ===
        function renderPreview() {
            document.getElementById('jsonPreview').innerText = JSON.stringify(fullData, null, 2);
        }
        function exportJson() {
            const blob = new Blob([JSON.stringify(fullData, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "full_script.json";
            a.click();
        }
        function importJson(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    fullData = JSON.parse(e.target.result);
                    // è¡¥å…¨ç»“æ„é˜²æŠ¥é”™
                    if(!fullData.worldview) fullData.worldview = {};
                    if(!fullData.characters) fullData.characters = {};
                    if(!fullData.main_story) fullData.main_story = {};
                    if(!fullData.side_stories) fullData.side_stories = {};
                    if(!fullData.char_routes) fullData.char_routes = {};
                    
                    switchSection('world');
                    renderPreview();
                    alert('å¯¼å…¥æˆåŠŸï¼');
                } catch(err) { alert('JSON æ ¼å¼é”™è¯¯'); }
            };
            reader.readAsText(file);
        }

        init();
    </script>
</body>
</html>