<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Utopia noteÂ·ä¹Œæ‰˜é‚¦æ‰‹è®°</title>
    <style>
        :root {
            --primary: #d946ef;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --bg-deep: #0f0720;
            --gradient-holo: linear-gradient(135deg, rgba(217,70,239,0.8), rgba(139,92,246,0.8), rgba(6,182,212,0.8));
            --glass-surface: rgba(20, 10, 35, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.7);
        }

        [data-theme="white"] { --primary: #5b7aef; --bg-deep: #f5f7fa; --text-main: #1a1a1a; --glass-surface: rgba(255, 255, 255, 0.8); }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'SF Pro Display', sans-serif; background: var(--bg-deep); color: var(--text-main); min-height: 100vh; overflow-x: hidden; transition: 0.5s; background-image: radial-gradient(circle at 10% 20%, rgba(217, 70, 239, 0.15), transparent 40%), radial-gradient(circle at 90% 80%, rgba(6, 182, 212, 0.15), transparent 40%); background-attachment: fixed; }
        
        .glass-panel { background: var(--glass-surface); backdrop-filter: blur(24px); border: 1px solid var(--glass-border); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .btn-glow { padding: 12px 20px; border: none; border-radius: 12px; background: var(--gradient-holo); color: white; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .btn-glow:active { transform: scale(0.98); }
        .input-modern { width: 100%; padding: 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; color: white; margin-bottom: 15px; }
        
        /* å¸ƒå±€ç±» */
        .view-section { display: none; padding-bottom: 80px; animation: fadeIn 0.4s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* æ¸¸æˆè¿è¡Œç•Œé¢ (Game Container) */
        .game-container { position: fixed; inset: 0; z-index: 200; display: none; background: #000; }
        .game-bg { position: absolute; inset: 0; background-size: cover; background-position: center; filter: brightness(0.6); transition: background-image 0.5s; }
        .game-ui { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(to top, #000 80%, transparent); }
        .game-text-box { background: rgba(0,0,0,0.75); padding: 20px; border-radius: 16px; color: #fff; min-height: 120px; font-size: 16px; line-height: 1.6; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); white-space: pre-wrap; }
        .game-option-btn { width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 50px; text-align: left; padding-left: 20px; cursor: pointer; transition: background 0.2s; }
        .game-option-btn:hover { background: var(--primary); border-color: var(--primary); }
        
        /* é¡¶éƒ¨æŒ‰é’®ç»„ */
        .game-top-bar { position: absolute; top: 20px; right: 20px; z-index: 20; display: flex; gap: 10px; }
        .game-btn-small { padding: 8px 16px; background: rgba(0,0,0,0.5); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; }
        
        /* Toast æç¤º */
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 30px; border-radius: 30px; display: none; z-index: 300; backdrop-filter: blur(5px); border: 1px solid var(--primary); animation: popIn 0.3s; }
        @keyframes popIn { from { transform: translate(-50%, -40%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }

        /* è®°å¿†å›å»Šæ ·å¼ */
        .log-container { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 20px; height: 60vh; overflow-y: auto; font-size: 14px; line-height: 1.8; white-space: pre-wrap; color: #ddd; }

        /* ä¸ªäººè®¾å®šä¿®å¤æ ·å¼ */
        .persona-strip { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0; min-height: 80px; }
        .persona-chip { flex: 0 0 auto; text-align: center; cursor: pointer; opacity: 0.6; transition: 0.3s; }
        .persona-chip.active { opacity: 1; transform: scale(1.1); }
        .persona-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--gradient-holo); display: flex; align-items: center; justify-content: center; margin: 0 auto 5px; overflow: hidden; border: 2px solid transparent; }
        .persona-chip.active .persona-avatar { border-color: #fff; }
        .persona-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .persona-avatar-slot { width: 100px; height: 100px; border-radius: 20px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; border: 1px dashed rgba(255,255,255,0.3); }
        .persona-avatar-slot img { width: 100%; height: 100%; object-fit: cover; }

        /* å…¶ä»–UIå¤ç”¨ */
        .dock-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; padding: 10px; border-radius: 24px; z-index: 100; }
        .dock-item { width: 50px; height: 50px; border-radius: 16px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); cursor: pointer; }
        .dock-item.active { background: rgba(255,255,255,0.2); color: white; }
        .card-instance { border-radius: 20px; overflow: hidden; margin: 20px; position: relative; height: 200px; }
        .card-instance img { width: 100%; height: 100%; object-fit: cover; }
        .card-info { position: absolute; bottom: 0; left: 0; right: 0; padding: 15px; background: linear-gradient(to top, #000, transparent); }
        
        .detail-layout { display: flex; gap: 20px; padding: 20px; flex-wrap: wrap; }
        .detail-cover img { width: 100%; max-width: 300px; border-radius: 16px; }
    </style>
</head>
<body onload="init()">

    <!-- Toast æç¤ºæ¡† -->
    <div id="toast">âœ… å­˜æ¡£æˆåŠŸ</div>

    <!-- 1. ç™»å½•é¡µ -->
    <div id="loginPage" class="login-page" style="display:flex; height:100vh; align-items:center; justify-content:center;">
        <div class="glass-panel" style="padding:40px; border-radius:24px; width:350px; text-align:center;">
            <h1 style="color:var(--primary); margin-bottom:10px;">UTOPIA NOTE</h1>
            <p style="color:var(--text-muted); margin-bottom:30px;">ä¹Œæ‰˜é‚¦æ‰‹è®°</p>
            <input id="username" class="input-modern" placeholder="è¾“å…¥ä»£å·...">
            <button class="btn-glow" onclick="enterHub()">è¿æ¥ç¥ç»å…ƒ</button>
        </div>
    </div>

    <!-- 2. ä¸»ç•Œé¢ -->
    <div id="mainHub" style="display:none;">
        <!-- é¡¶éƒ¨ -->
        <div style="padding:20px; display:flex; justify-content:space-between;">
            <span style="font-weight:bold; font-size:18px;">ğŸ‘¤ <span id="displayName"></span></span>
            <span style="color:var(--accent);">ğŸ’ 1250</span>
        </div>

        <!-- è§†å›¾ï¼šå‰¯æœ¬ä¸­å¿ƒ -->
        <div id="view-hub" class="view-section active">
            <h2 style="padding:0 20px;">æ¢ç´¢ä¸–ç•Œ</h2>
            <div class="card-instance" onclick="showDetail()">
                <img src="https://images.unsplash.com/photo-1599707367072-cd6ad6cb3d2e?w=600&q=80">
                <div class="card-info">
                    <h3>ç´«ç¦åŸè¿·æ¢¦</h3>
                    <p style="font-size:12px; opacity:0.8;">å¤ä»£ Â· æƒè°‹ Â· æ‹çˆ±</p>
                </div>
            </div>
        </div>

        <!-- è§†å›¾ï¼šè¯¦æƒ…é¡µ -->
        <div id="view-detail" class="view-section">
            <div class="detail-layout">
                <div class="detail-cover">
                    <img src="https://images.unsplash.com/photo-1599707367072-cd6ad6cb3d2e?w=800">
                </div>
                <div style="flex:1;">
                    <button onclick="switchView('hub')" style="background:none; border:none; color:white; margin-bottom:10px;">â† è¿”å›</button>
                    <h1>ç´«ç¦åŸè¿·æ¢¦</h1>
                    <p style="line-height:1.6; color:var(--text-muted); margin:15px 0;">ç©¿è¶Šåˆ°æ˜æœæ°¸ä¹å¹´é—´ï¼Œä½ æˆä¸ºäº†ä¸€åå…¥å®«çš„ç§€å¥³ã€‚åœ¨è¿™åº§æ·±å®«ä¸­ï¼Œæ¯ä¸€ä¸ªé€‰æ‹©éƒ½å…³ä¹ç”Ÿæ­»ä¸çˆ±æ¨ã€‚</p>
                    
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn-glow" style="flex:1" onclick="startGame('start')">ğŸ“– æ–°æ—…ç¨‹</button>
                        <button class="btn-glow" style="flex:1; background:rgba(16, 185, 129, 0.3);" onclick="startGame('continue')">ğŸ“‚ ç»§ç»­å‰§æƒ…</button>
                    </div>
                    <button class="btn-glow" style="width:100%; margin-top:10px; background:rgba(255,255,255,0.1);" onclick="startGame('endless')">â™¾ï¸ æ— å°½æ¨¡å¼</button>
                </div>
            </div>
        </div>

        <!-- è§†å›¾ï¼šè®°å¿†å›å»Š (æ–°å¢å›æ”¾åŠŸèƒ½) -->
        <div id="view-gallery" class="view-section">
            <div style="padding:20px;">
                <h2>å‰§æƒ…å›æ”¾</h2>
                <p style="color:var(--text-muted); font-size:12px; margin-bottom:10px;">è¿™é‡Œè®°å½•äº†ä½ ç»å†è¿‡çš„æ‰€æœ‰æ•…äº‹ç‰‡æ®µã€‚</p>
                <div id="storyLog" class="log-container">
                    æš‚æ— è®°å¿†ã€‚è¯·å…ˆè¿›è¡Œæ¸¸æˆã€‚
                </div>
                <button class="btn-glow" onclick="clearMemory()" style="margin-top:10px; background:rgba(239, 68, 68, 0.5);">ğŸ—‘ï¸ æ¸…ç©ºè®°å¿†</button>
            </div>
        </div>

        <!-- è§†å›¾ï¼šé“å…·å•†åº— -->
        <div id="view-shop" class="view-section">
            <div style="padding:20px;">
                <h2>é“å…·å•†åº—</h2>
                <div class="glass-panel" style="padding:20px; border-radius:16px; margin-top:20px;">
                    <p>å•†åº—åŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- è§†å›¾ï¼šæˆ‘çš„è®¾å®š (Bugä¿®å¤ç‰ˆ) -->
        <div id="view-persona" class="view-section">
            <div class="persona-container" style="padding:20px;">
                <h2>æˆ‘çš„è®¾å®š</h2>
                
                <!-- å¤´åƒæ¡ -->
                <div class="glass-panel" style="padding:15px; border-radius:20px; margin-bottom:20px;">
                    <div class="persona-strip" id="persona-strip"></div>
                </div>

                <!-- ç¼–è¾‘è¡¨å• -->
                <div class="glass-panel persona-form" style="padding:20px; border-radius:20px;">
                    <div class="persona-row">
                        <span style="font-size:12px; color:var(--text-muted);">å§“å</span>
                        <input id="persona-name" class="input-modern" placeholder="è§’è‰²å">
                    </div>
                    <div class="persona-row">
                        <span style="font-size:12px; color:var(--text-muted);">å¤´åƒ</span>
                        <div style="display:flex; gap:15px; align-items:center;">
                            <div class="persona-avatar-slot" id="persona-avatar-slot" onclick="triggerAvatarUpload()">
                                <img id="persona-avatar-preview" src="" style="display:none;">
                                <span id="persona-placeholder" style="font-size:12px;">ç‚¹å‡»ä¸Šä¼ </span>
                            </div>
                            <span style="font-size:12px; color:var(--text-muted);">ä»…ä¿å­˜åœ¨æœ¬åœ°</span>
                        </div>
                        <input type="file" id="persona-avatar-input" accept="image/*" style="display:none;" onchange="onAvatarFileChange(event)">
                    </div>
                    <button class="btn-glow" onclick="savePersona()" style="margin-top:15px;">ä¿å­˜è®¾å®š</button>
                </div>
            </div>
        </div>

        <!-- è§†å›¾ï¼šè®¾ç½®é¡µ -->
        <div id="view-settings" class="view-section">
            <div style="padding:20px;">
                <h2>ç³»ç»Ÿè®¾ç½®</h2>
                <div class="glass-panel" style="padding:20px; border-radius:16px; margin-top:20px;">
                    <h3>API è¿æ¥ (å¿…å¡«)</h3>
                    <input id="apiUrl" class="input-modern" placeholder="API åœ°å€">
                    <input id="apiKey" class="input-modern" type="password" placeholder="sk-...">
                    <button class="btn-glow" onclick="saveApi()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                </div>
                
                <!-- å‰§æœ¬ä¸Šä¼  -->
                <div class="glass-panel" style="padding:20px; border-radius:16px; margin-top:20px;">
                    <h3>å‰§æœ¬ç®¡ç†</h3>
                    <div style="margin-top:10px; display:flex; gap:10px;">
                        <button class="btn-glow" onclick="document.getElementById('storyUpload').click()" style="background:rgba(255,255,255,0.1);">ğŸ“‚ å¯¼å…¥å‰§æœ¬</button>
                        <input type="file" id="storyUpload" accept=".json" style="display:none;" onchange="handleStoryUpload(event)">
                        <button class="btn-glow" onclick="resetStory()" style="background:rgba(239,68,68,0.5);">ğŸ—‘ï¸ é‡ç½®</button>
                    </div>
                    <div id="storyMsg" style="font-size:12px; margin-top:5px; color:#10b981;"></div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <div class="dock-nav glass-panel">
            <div class="dock-item active" onclick="switchView('hub')">ğŸ </div>
            <div class="dock-item" onclick="switchView('gallery')">ğŸ“œ</div> <!-- è®°å¿†å›å»Š -->
            <div class="dock-item" onclick="switchView('shop')">ğŸ›’</div>
            <div class="dock-item" onclick="switchView('persona')">ğŸ‘¤</div>
            <div class="dock-item" onclick="switchView('settings')">âš™ï¸</div>
        </div>
    </div>

    <!-- 3. æ¸¸æˆè¿è¡Œå®¹å™¨ -->
    <div id="gameContainer" class="game-container">
        <div id="gameBg" class="game-bg"></div>
        
        <!-- é¡¶éƒ¨æŒ‰é’®ç»„ (æ–°å¢ä¿å­˜æŒ‰é’®) -->
        <div class="game-top-bar">
            <button class="game-btn-small" onclick="saveProgress(true)">ğŸ’¾ å­˜æ¡£</button>
            <button class="game-btn-small" onclick="exitGame()">âŒ é€€å‡º</button>
        </div>
        
        <div class="game-ui">
            <div id="gameTextBox" class="game-text-box"></div>
            <div id="gameOptions"></div>
        </div>
    </div>

    <script>
        // === å…¨å±€çŠ¶æ€ ===
        const USERNAME_STORAGE = 'infinite.username';
        const PERSONA_STORAGE = 'infinite.personas';
        const STORY_STORAGE = 'infinite.customStory';
        const SAVE_STORAGE = 'infinite.save';

        let currentPersonaId = null;
        let currentSceneId = null;
        let activeStoryData = {};
        
        // é»˜è®¤å‰§æœ¬
        const defaultStory = {
            "start": {
                type: "fixed",
                text: "å¤œé£å¾®å‡‰ï¼Œä½ ç«™åœ¨ç´«ç¦åŸçš„é•¿è¡—ä¸Š...",
                bg: "https://images.unsplash.com/photo-1599707367072-cd6ad6cb3d2e?w=800",
                options: [
                    { text: "å›æœ›å®«é—¨", nextScene: "scene_look_back" },
                    { text: "è¸å…¥æ·±å®«", nextScene: "scene_enter" }
                ]
            },
            "scene_look_back": {
                type: "fixed",
                text: "ä½ å›å¤´æœ›å»ï¼Œå®«é—¨å·²ç„¶ç´§é—­ã€‚",
                options: [{ text: "ç»§ç»­èµ°", nextScene: "scene_enter" }]
            },
            "scene_enter": {
                type: "ai",
                bg: "https://images.unsplash.com/photo-1563298723-dcfebaa392e3?w=800",
                prompt: "åœºæ™¯ï¼šæ·±å¤œçš„å‚¨ç§€å®«ã€‚äººç‰©ï¼šæŒäº‹å§‘å§‘ã€‚äº‹ä»¶ï¼šä¸»è§’è¿Ÿåˆ°ã€‚è¯·ç”ŸæˆæŒäº‹å§‘å§‘è®­æ–¥ä¸»è§’çš„å‰§æƒ…ã€‚200å­—ã€‚",
                options: [{ text: "ä½å¤´è®¤é”™", nextScene: "ai_next_1" }]
            },
            "ai_start": {
                type: "ai",
                prompt: "ç”Ÿæˆä¸€ä¸ªæ— é™æµèµ›åšæœ‹å…‹é£æ ¼å¼€åœºã€‚200å­—ã€‚",
                options: [{text:"é†’æ¥", nextScene:"ai_next"}]
            }
        };

        // åˆå§‹åŒ–
        function init() {
            // æ¢å¤ç”¨æˆ·å
            const user = localStorage.getItem(USERNAME_STORAGE);
            if(user) {
                document.getElementById('username').value = user;
                enterHub();
            }
            // æ¢å¤API
            const config = JSON.parse(localStorage.getItem('apiConfig') || '{}');
            if(config.url) document.getElementById('apiUrl').value = config.url;
            if(config.key) document.getElementById('apiKey').value = config.key;

            // åŠ è½½å‰§æœ¬
            loadCustomStory();
            
            // åˆå§‹åŒ–äººè®¾
            initPersonas();
        }

        // === è§†å›¾æ§åˆ¶ ===
        function enterHub() {
            const name = document.getElementById('username').value;
            if(!name) return;
            localStorage.setItem(USERNAME_STORAGE, name);
            document.getElementById('displayName').innerText = name;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainHub').style.display = 'block';
        }

        function switchView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            
            // å¦‚æœåˆ‡åˆ°å›å»Šï¼Œåˆ·æ–°æ—¥å¿—
            if (id === 'gallery') refreshStoryLog();
        }

        function showDetail() { switchView('detail'); }

        // === æ¸¸æˆå¼•æ“ ===
        function startGame(mode) {
            document.getElementById('mainHub').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';

            // ç»§ç»­æ¸¸æˆé€»è¾‘
            if (mode === 'continue') {
                const saveStr = localStorage.getItem(SAVE_STORAGE);
                if (saveStr) {
                    const save = JSON.parse(saveStr);
                    // æ¢å¤è®°å¿†
                    if(save.memory) activeStoryData.memory = save.memory;
                    loadScene(save.sceneId);
                    return;
                } else {
                    alert("æ— å­˜æ¡£ï¼Œå¼€å§‹æ–°æ¸¸æˆ");
                }
            }

            // æ–°æ¸¸æˆåˆå§‹åŒ–
            if (mode !== 'continue') {
                activeStoryData.memory = ""; // æ¸…ç©ºè®°å¿†
                localStorage.removeItem(SAVE_STORAGE);
            }

            let firstScene = 'start';
            if (mode === 'endless') firstScene = 'ai_start';
            else if (mode === 'start') firstScene = 'start';
            
            // å®¹é”™
            if (!activeStoryData[firstScene] && !firstScene.includes('ai')) {
                firstScene = Object.keys(activeStoryData)[0] || 'start';
            }

            loadScene(firstScene);
        }

        function exitGame() {
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('mainHub').style.display = 'block';
            switchView('detail');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        // === æ ¸å¿ƒå­˜æ¡£ ===
        function saveProgress(showMsg = false) {
            if (!currentSceneId) return;
            const save = {
                sceneId: currentSceneId,
                memory: activeStoryData.memory || "",
                timestamp: Date.now()
            };
            localStorage.setItem(SAVE_STORAGE, JSON.stringify(save));
            if (showMsg) showToast("âœ… å­˜æ¡£æˆåŠŸ");
        }

        async function loadScene(sceneId) {
            currentSceneId = sceneId;
            saveProgress(); // è‡ªåŠ¨å­˜æ¡£

            let scene = activeStoryData[sceneId];
            
            // æ„é€ ä¸´æ—¶ AI èŠ‚ç‚¹
            if (!scene && sceneId.startsWith('ai_')) {
                scene = {
                    type: 'ai',
                    prompt: `ï¼ˆæ¥ç»­å‰§æƒ…ï¼‰è¯·ç»§ç»­åˆšæ‰çš„æ•…äº‹ã€‚`,
                    bg: ''
                };
            }

            if (!scene) { alert('å‰§æœ¬ç»“æŸ'); exitGame(); return; }

            const bgEl = document.getElementById('gameBg');
            const optEl = document.getElementById('gameOptions');
            const textEl = document.getElementById('gameTextBox');

            if(bgEl && scene.bg) bgEl.style.backgroundImage = `url('${scene.bg}')`;
            optEl.innerHTML = '';

            if (scene.type === 'fixed') {
                typeWriter(scene.text);
                renderOptions(scene.options);
                updateMemory(scene.text); // å›ºå®šå‰§æƒ…ä¹Ÿè¦è®°å…¥è®°å¿†
            } else if (scene.type === 'ai') {
                textEl.innerHTML = 'âš¡ æ­£åœ¨ç”Ÿæˆå‰§æƒ…...';
                const res = await generateAiSceneText(sceneId, scene);
                
                if (typeof res === 'string' && res.startsWith('âŒ')) {
                    typeWriter(res);
                    renderOptions([{text:"é‡è¯•", nextScene: sceneId}]);
                } else {
                    typeWriter(res.text);
                    renderOptions(res.options);
                    updateMemory(res.text); // è®°å…¥è®°å¿†
                }
            }
        }

        function updateMemory(text) {
            let mem = activeStoryData.memory || "";
            mem += "\n" + text;
            if (mem.length > 2000) mem = "..." + mem.slice(-2000); // ç®€å•çš„è®°å¿†çª—å£
            activeStoryData.memory = mem;
            saveProgress();
        }

        function typeWriter(text) {
            const el = document.getElementById('gameTextBox');
            el.innerHTML = '';
            let i = 0;
            const timer = setInterval(() => {
                el.innerHTML += text.charAt(i);
                i++;
                if(i >= text.length) clearInterval(timer);
            }, 20);
            el.onclick = () => { clearInterval(timer); el.innerHTML = text; };
        }

        function renderOptions(opts) {
            const box = document.getElementById('gameOptions');
            box.innerHTML = '';
            if(!opts) return;
            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'game-option-btn';
                btn.innerText = opt.text || opt.label;
                btn.onclick = () => {
                    // å¤„ç† AI ç”Ÿæˆçš„ nextScene
                    let next = opt.nextScene;
                    if (!next || next === 'null') {
                        next = 'ai_next_' + Date.now();
                        // é¢„å­˜ Prompt
                        activeStoryData[next] = {
                            type: 'ai',
                            prompt: `ç©å®¶é€‰æ‹©äº†ï¼š${opt.text}ã€‚è¯·ç»§ç»­å‰§æƒ…ã€‚`
                        };
                    }
                    loadScene(next);
                };
                box.appendChild(btn);
            });
        }

        // === AI ç”Ÿæˆ (å¸¦è®°å¿†) ===
        async function generateAiSceneText(sceneId, scene) {
            const configRaw = localStorage.getItem('apiConfig');
            if(!configRaw) return 'âŒ æœªé…ç½® API';
            const config = JSON.parse(configRaw);
            
            // URL ä¿®æ­£
            let url = config.url || "https://api.openai.com/v1";
            url = url.replace(/\/$/, "");
            if(!url.includes("chat/completions")) url = url.endsWith("/v1") ? url+"/chat/completions" : url+"/v1/chat/completions";

            // æ„é€ è®°å¿† Prompt
            const memory = activeStoryData.memory || "";
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªæ–‡å­—æ¸¸æˆAIã€‚
ã€å‰æƒ…æè¦ã€‘ï¼š${memory}
ã€æŒ‡ä»¤ã€‘ï¼šæ¥ç»­å‰§æƒ…ï¼Œ200å­—ä»¥å†…ã€‚
è¿”å›æ ¼å¼ï¼šçº¯JSON {"text":"...", "options":[{"text":"...", "nextScene":"null"}]}`;

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer '+config.key},
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        stream: false,
                        messages: [
                            {role:'system', content: systemPrompt},
                            {role:'user', content: scene.prompt || "ç»§ç»­"}
                        ]
                    })
                });
                
                const data = await res.json();
                if(data.error) return `âŒ APIé”™è¯¯: ${data.error.message}`;
                
                let content = data.choices?.[0]?.message?.content;
                if(!content) return `âŒ è¿”å›ç©º`;
                
                try {
                    return JSON.parse(content.replace(/```json/g,'').replace(/```/g,'').trim());
                } catch {
                    return { text: content, options: [{text:"ç»§ç»­", nextScene:"ai_next"}] };
                }
            } catch(e) { return `âŒ ç½‘ç»œé”™è¯¯: ${e.message}`; }
        }

        // === è®°å¿†å›å»Šé€»è¾‘ ===
        function refreshStoryLog() {
            const box = document.getElementById('storyLog');
            const mem = localStorage.getItem(SAVE_STORAGE);
            if (mem) {
                const data = JSON.parse(mem);
                box.innerText = data.memory || "æš‚æ— è®°å¿†";
            } else {
                box.innerText = "æš‚æ— è®°å½•";
            }
        }
        function clearMemory() {
            if(confirm('ç¡®å®šæ¸…ç©ºè®°å¿†ï¼Ÿ')) {
                localStorage.removeItem(SAVE_STORAGE);
                if(activeStoryData) activeStoryData.memory = "";
                refreshStoryLog();
            }
        }

        // === è®¾å®šä¸APIé…ç½®å‡½æ•° ===
        function saveApi() {
            const url = document.getElementById('apiUrl').value;
            const key = document.getElementById('apiKey').value;
            localStorage.setItem('apiConfig', JSON.stringify({url, key}));
            showToast('API å·²ä¿å­˜');
        }
        function loadApiConfig() {
            const c = JSON.parse(localStorage.getItem('apiConfig') || '{}');
            if(c.url) document.getElementById('apiUrl').value = c.url;
            if(c.key) document.getElementById('apiKey').value = c.key;
        }
        
        // å‰§æœ¬åŠ è½½
        function loadCustomStory() {
            const raw = localStorage.getItem(STORY_STORAGE);
            if(raw) {
                try {
                    const d = JSON.parse(raw);
                    activeStoryData = d.main_story || d;
                } catch {}
            } else {
                activeStoryData = storyData;
            }
        }
        function handleStoryUpload(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                localStorage.setItem(STORY_STORAGE, ev.target.result);
                loadCustomStory();
                document.getElementById('storyMsg').innerText = "âœ… å·²åŠ è½½ " + file.name;
            };
            reader.readAsText(file);
        }
        function resetStory() {
            localStorage.removeItem(STORY_STORAGE);
            activeStoryData = storyData;
            document.getElementById('storyMsg').innerText = "å·²æ¢å¤é»˜è®¤";
        }

        // ä¸ªäººè®¾å®šé€»è¾‘ (ä¿®å¤ç‰ˆ)
        function initPersonas() { renderPersonaStrip(); }
        function loadPersonas() { return JSON.parse(localStorage.getItem(PERSONA_STORAGE) || '[]'); }
        function renderPersonaStrip() {
            const list = loadPersonas();
            const strip = document.getElementById('persona-strip');
            strip.innerHTML = '<div class="persona-chip" onclick="selectPersona(null)"><div class="persona-avatar" style="background:#444;">+</div><div class="persona-name">æ–°å»º</div></div>';
            list.forEach(p => {
                const div = document.createElement('div');
                div.className = 'persona-chip';
                div.innerHTML = `<div class="persona-avatar">${p.avatar ? `<img src="${p.avatar}">` : p.name[0]}</div><div class="persona-name">${p.name}</div>`;
                div.onclick = () => selectPersona(p.id);
                strip.appendChild(div);
            });
        }
        function selectPersona(id) {
            currentPersonaId = id;
            const p = loadPersonas().find(x => x.id === id) || {name:'', desc:'', avatar:''};
            document.getElementById('persona-name').value = p.name;
            document.getElementById('persona-desc').value = p.desc;
            const preview = document.getElementById('persona-avatar-preview');
            const holder = document.getElementById('persona-placeholder');
            if(p.avatar) { preview.src = p.avatar; preview.style.display='block'; holder.style.display='none'; }
            else { preview.style.display='none'; holder.style.display='block'; }
        }
        function savePersona() {
            const name = document.getElementById('persona-name').value;
            const desc = document.getElementById('persona-desc').value;
            const preview = document.getElementById('persona-avatar-preview');
            const avatar = preview.style.display === 'block' ? preview.src : '';
            if(!name) return alert('è¯·è¾“å…¥åå­—');
            
            let list = loadPersonas();
            if(currentPersonaId) {
                const idx = list.findIndex(x => x.id === currentPersonaId);
                if(idx >= 0) list[idx] = { ...list[idx], name, desc, avatar };
            } else {
                list.push({ id: Date.now(), name, desc, avatar });
            }
            localStorage.setItem(PERSONA_STORAGE, JSON.stringify(list));
            renderPersonaStrip();
            showToast('è®¾å®šå·²ä¿å­˜');
        }
        function triggerAvatarUpload() { document.getElementById('persona-avatar-input').click(); }
        function onAvatarFileChange(e) {
            const f = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = document.getElementById('persona-avatar-preview');
                img.src = ev.target.result;
                img.style.display = 'block';
                document.getElementById('persona-placeholder').style.display = 'none';
            };
            reader.readAsDataURL(f);
        }
    </script>
</body>
</html>
